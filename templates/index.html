<head>
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">

<body>
    {% extends "base.html" %}
    {% block content %}
    <div class="container">
    	<header class="top">
    		<div>
    			<h1 class="brand">{{ config.SITE_NAME }}</h1>
    			<div id="location-display" class="muted"></div>
    			<div id="date-display" style="font-size:0.95rem;color:#64748b;margin-top:6px;"></div>
    		</div>
    		<button id="open-settings" class="btn">Settings</button>
    	</header>
    
    	<main class="grid">
    		<section class="card uplift-card" id="uplift-card">
    			<div id="uplift" class="uplift-text">Loading…</div>
    		</section>
    
    		<section class="card sun-card" id="sun-card">
    			<div id="sun-meta" class="sun-meta">Loading sun info…</div>
    		</section>
    	</main>
    
    	<footer class="foot">A small daily nudge towards the seasons.</footer>
    </div>
    
    <!-- Settings overlay -->
    <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    	<div class="modal-content">
    		<h3>Settings</h3>
    		<label>City
    			<input id="city" type="text" list="city-list" placeholder="Zurich, Switzerland" autocomplete="off">
    			<datalist id="city-list"></datalist>
    		</label>
    		<div class="modal-actions">
    			<button id="save" class="btn primary">Save</button>
    			<button id="close" class="btn">Close</button>
    		</div>
    	</div>
    </div>
    
    <script>
    /* simple, compatible JS */
    var defaults = {city: "{{ config.DEFAULT_CITY }}", lat: {{ config.DEFAULT_LAT }}, lon: {{ config.DEFAULT_LON }} };
    
    function getStored() {
    	try {
    		var s = localStorage.getItem('sh_location');
    		if (!s) return {city: defaults.city, lat: defaults.lat, lon: defaults.lon, name: defaults.city};
    		var o = JSON.parse(s);
    		if (typeof o.lat !== 'number' || typeof o.lon !== 'number') return {city: defaults.city, lat: defaults.lat, lon: defaults.lon, name: defaults.city};
    		if (!o.name) o.name = o.city || defaults.city;
    		return o;
    	} catch (e) { return {city: defaults.city, lat: defaults.lat, lon: defaults.lon, name: defaults.city}; }
    }
    function store(loc){ try { localStorage.setItem('sh_location', JSON.stringify(loc)); } catch(e){} }
    async function safeFetchJson(url){
    	var res = await fetch(url);
    	if (!res.ok) throw new Error('Network error: ' + res.status);
    	return res.json();
    }
    function updateLocationDisplay(loc){
    	var el = document.getElementById('location-display');
    	if (!el) return;
    	el.textContent = loc.name || loc.city || '';
    }
    function updateDateDisplay(){
    	var el = document.getElementById('date-display');
    	if (!el) return;
    	var now = new Date();
    	el.textContent = now.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    }
    
    async function refreshAll(){
    	var loc = getStored();
    	updateLocationDisplay(loc);
    	updateDateDisplay();
    
    	// uplift
    	try {
    		var u = await safeFetchJson('/api/uplift?lat=' + encodeURIComponent(loc.lat) + '&lon=' + encodeURIComponent(loc.lon));
    		document.getElementById('uplift').innerHTML = (u.uplift || (u.error ? u.error : 'No uplift')).replace(/\n/g,'<br>');
    	} catch(e){ document.getElementById('uplift').textContent = 'Error loading uplift'; }
    
    	// sun small meta
    	try {
    		var s = await safeFetchJson('/api/solar?lat=' + encodeURIComponent(loc.lat) + '&lon=' + encodeURIComponent(loc.lon));
    		if (s && s.daylight) {
    			var ds = s.daylight;
    			var text = '';
    			// human friendly wording
    			var dy = ds.delta_since_yesterday_minutes;
    			var ds_sol = ds.delta_since_solstice_minutes;
    			if (dy > 0) text += 'A bit longer than yesterday (' + dy + ' min).';
    			else if (dy < 0) text += 'Slightly shorter than yesterday (' + Math.abs(dy) + ' min).';
    			else text += 'Same length as yesterday.';
    			text += ' Since the winter solstice it is ';
    			if (ds_sol > 0) text += 'about ' + ds_sol + ' minutes longer.';
    			else if (ds_sol < 0) text += 'about ' + Math.abs(ds_sol) + ' minutes shorter.';
    			else text += 'about the same as at the solstice.';
    			document.getElementById('sun-meta').textContent = text;
    		} else {
    			document.getElementById('sun-meta').textContent = (s && s.error) ? s.error : 'Could not load sun info';
    		}
    	} catch(e){ document.getElementById('sun-meta').textContent = 'Error loading sun info'; }
    }
    
    // city search with datalist
    function setupCitySearch() {
    	var cityIn = document.getElementById('city');
    	var dataList = document.getElementById('city-list');
    	var cityMap = {};
    	var timer = null;
    
    	function populateList(items){
    		while (dataList.firstChild) dataList.removeChild(dataList.firstChild);
    		cityMap = {};
    		for (var i=0;i<items.length;i++){
    			var it = items[i];
    			if (!it || !it.name) continue;
    			var opt = document.createElement('option');
    			opt.value = it.name;
    			dataList.appendChild(opt);
    			cityMap[it.name] = {lat: it.lat, lon: it.lon, name: it.name};
    		}
    	}
    
    	function search(q){
    		if (!q || q.length < 2) { populateList([]); return; }
    		safeFetchJson('/api/geocode_suggest?city=' + encodeURIComponent(q)).then(function(res){
    			populateList(res || []);
    		}).catch(function(){ populateList([]); });
    	}
    
    	cityIn.addEventListener('input', function(){
    		var q = (cityIn.value || '').trim();
    		if (timer) clearTimeout(timer);
    		timer = setTimeout(function(){ search(q); }, 300);
    	});
    
    	return {
    		resolve: function(value, fallback) {
    			if (cityMap[value]) return Promise.resolve(cityMap[value]);
    			if (!value) return Promise.resolve(fallback);
    			return safeFetchJson('/api/geocode?city=' + encodeURIComponent(value)).then(function(r){
    				if (r && !r.error) return {lat: r.lat, lon: r.lon, name: r.name || value};
    				return fallback;
    			}).catch(function(){ return fallback; });
    		}
    	};
    }
    
    // modal & handlers
    function setupUI(){
    	var modal = document.getElementById('modal');
    	var openBtn = document.getElementById('open-settings');
    	var closeBtn = document.getElementById('close');
    	var saveBtn = document.getElementById('save');
    	var cityIn = document.getElementById('city');
    	if (!modal) return;
    	var citySearch = setupCitySearch();
    
    	function openSettings(){
    		var loc = getStored();
    		cityIn.value = loc.city || loc.name || defaults.city;
    		modal.style.display = 'flex';
    		modal.setAttribute('aria-hidden','false');
    		cityIn.focus();
    	}
    	function closeSettings(){
    		modal.style.display = 'none';
    		modal.setAttribute('aria-hidden','true');
    	}
    
    	if (openBtn) openBtn.addEventListener('click', openSettings);
    	if (closeBtn) closeBtn.addEventListener('click', closeSettings);
    	if (saveBtn) saveBtn.addEventListener('click', function(){
    		var city = (cityIn.value || '').trim();
    		if (!city) { closeSettings(); return; }
    		citySearch.resolve(city, {lat: defaults.lat, lon: defaults.lon, name: city}).then(function(loc){
    			var out = {city: city, lat: loc.lat, lon: loc.lon, name: loc.name || city};
    			store(out);
    			updateLocationDisplay(out);
    			refreshAll();
    			closeSettings();
    		});
    	});
    	document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeSettings(); });
    }
    
    window.addEventListener('load', function(){
    	setupUI();
    	refreshAll();
    });
    </script>
    {% endblock %}
</body>
</html>