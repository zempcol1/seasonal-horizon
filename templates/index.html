<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seasonal Horizon</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='icon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <main class="container">
        <header>
            <div class="brand">
                <span class="brand-icon">‚òÄÔ∏è</span>
                <h1>Seasonal Horizon</h1>
            </div>
            <button class="icon-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        </header>

        <section class="card">
            <p id="location-label" class="location-label">Zurich</p>
            <div id="loader" class="loader">
                <div class="spinner"></div>
                <span id="loader-text">Reading the sky...</span>
            </div>
            <div id="content" class="content hidden">
                <p id="uplift-text" class="uplift-text"></p>
                
                <div class="facts-section">
                    <div class="facts-row">
                        <div class="fact">
                            <span class="label">üåÖ Sunrise</span>
                            <span id="f-sunrise" class="val">--</span>
                        </div>
                        <div class="fact">
                            <span class="label">üåá Sunset</span>
                            <span id="f-sunset" class="val">--</span>
                        </div>
                        <div class="fact">
                            <span class="label">‚òÄÔ∏è Daylight</span>
                            <span id="f-length" class="val">--</span>
                        </div>
                    </div>
                </div>

                <div class="facts-section">
                    <div class="facts-row">
                        <div class="fact delta-fact">
                            <span class="label">vs Yesterday</span>
                            <span id="f-delta-d" class="val">--</span>
                        </div>
                        <div class="fact delta-fact">
                            <span class="label">vs Last Week</span>
                            <span id="f-delta-w" class="val">--</span>
                        </div>
                        <div class="fact delta-fact">
                            <span class="label">vs Solstice</span>
                            <span id="f-delta-s" class="val">--</span>
                        </div>
                    </div>
                </div>

                <div class="facts-section weather-section">
                    <div class="facts-row">
                        <div class="fact weather-fact">
                            <span id="weather-icon" class="weather-icon">‚òÄÔ∏è</span>
                            <span id="f-weather" class="val">Clear</span>
                        </div>
                        <div class="fact">
                            <span class="label">üå°Ô∏è High Today</span>
                            <span id="f-temp" class="val">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <footer class="footer">
            <p>Your daily reminder that light always returns.</p>
        </footer>
    </main>

    <div id="overlay" class="overlay hidden" onclick="handleOverlayClick(event)">
        <div class="overlay-box">
            <div class="overlay-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="closeSettings()" title="Close">&times;</button>
            </div>
            
            <div class="settings-section">
                <h3>Location</h3>
                <label>Search for a city</label>
                <input type="text" id="city-input" placeholder="e.g. Berlin, Tokyo, New York..." autocomplete="off">
                <ul id="city-results" class="results-list"></ul>
                <div class="current-location" id="current-loc"></div>
            </div>
            
            <div class="version-section">
                <span class="version-label" onclick="toggleChangelog()">v0.3</span>
                <div id="changelog" class="changelog hidden">
                    <ul>
                        <li><strong>v0.3</strong> ‚Äì Smart forecast narratives with 7-day weather analysis</li>
                        <li><strong>v0.2</strong> ‚Äì Location selection and improved text generation</li>
                        <li><strong>v0.1</strong> ‚Äì Initial release</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const state = {
            city: localStorage.getItem('sh_city') || 'Zurich',
            lat: parseFloat(localStorage.getItem('sh_lat')) || 47.37,
            lon: parseFloat(localStorage.getItem('sh_lon')) || 8.54
        };

        const WEATHER_ICONS = {
            0: ['‚òÄÔ∏è', 'Clear'], 1: ['üå§Ô∏è', 'Mostly Clear'], 2: ['‚õÖ', 'Partly Cloudy'],
            3: ['‚òÅÔ∏è', 'Overcast'], 45: ['üå´Ô∏è', 'Foggy'], 48: ['üå´Ô∏è', 'Icy Fog'],
            51: ['üå¶Ô∏è', 'Light Drizzle'], 53: ['üå¶Ô∏è', 'Drizzle'], 55: ['üåßÔ∏è', 'Heavy Drizzle'],
            61: ['üåßÔ∏è', 'Light Rain'], 63: ['üåßÔ∏è', 'Rain'], 65: ['üåßÔ∏è', 'Heavy Rain'],
            71: ['üå®Ô∏è', 'Light Snow'], 73: ['üå®Ô∏è', 'Snow'], 75: ['‚ùÑÔ∏è', 'Heavy Snow'],
            77: ['üå®Ô∏è', 'Snow Grains'], 80: ['üå¶Ô∏è', 'Light Showers'], 81: ['üåßÔ∏è', 'Showers'],
            82: ['‚õàÔ∏è', 'Heavy Showers'], 85: ['üå®Ô∏è', 'Snow Showers'], 86: ['‚ùÑÔ∏è', 'Heavy Snow'],
            95: ['‚õàÔ∏è', 'Thunderstorm'], 96: ['‚õàÔ∏è', 'Hail Storm'], 99: ['‚õàÔ∏è', 'Severe Storm']
        };

        // Global abort controllers
        let dataController = null;
        let searchController = null;
        let searchTimer = null;
        let searchRequestId = 0;

        document.getElementById('location-label').textContent = state.city;
        fetchData();

        async function fetchData() {
            // Abort any pending data request
            if (dataController) {
                dataController.abort();
            }
            dataController = new AbortController();
            
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const content = document.getElementById('content');
            
            loader.classList.remove('hidden');
            content.classList.add('hidden');
            loaderText.textContent = 'Reading the sky...';

            try {
                const res = await fetch(
                    `/api/uplift?lat=${state.lat}&lon=${state.lon}&city=${encodeURIComponent(state.city)}`,
                    { signal: dataController.signal }
                );
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                if (data.success) {
                    // Apply highlights to text
                    const highlightedText = applyHighlights(data.text, data.highlights || []);
                    document.getElementById('uplift-text').innerHTML = highlightedText;
                    
                    document.getElementById('f-sunrise').textContent = data.facts.sunrise;
                    document.getElementById('f-sunset').textContent = data.facts.sunset;
                    document.getElementById('f-length').textContent = data.facts.day_length;
                    
                    const deltaD = document.getElementById('f-delta-d');
                    const deltaW = document.getElementById('f-delta-w');
                    const deltaS = document.getElementById('f-delta-s');
                    
                    deltaD.textContent = data.facts.delta_yesterday;
                    deltaW.textContent = data.facts.delta_week;
                    deltaS.textContent = data.facts.delta_solstice;

                    deltaD.className = 'val ' + (data.facts.delta_yesterday.includes('+') ? 'positive' : (data.facts.delta_yesterday.includes('-') ? 'negative' : ''));
                    deltaW.className = 'val ' + (data.facts.delta_week.includes('+') ? 'positive' : (data.facts.delta_week.includes('-') ? 'negative' : ''));
                    deltaS.className = 'val ' + (data.facts.delta_solstice.includes('+') ? 'positive' : (data.facts.delta_solstice.includes('-') ? 'negative' : ''));

                    const weatherCode = data.facts.weather_code || 0;
                    const weatherInfo = WEATHER_ICONS[weatherCode] || WEATHER_ICONS[0];
                    document.getElementById('weather-icon').textContent = weatherInfo[0];
                    document.getElementById('f-weather').textContent = weatherInfo[1];
                    document.getElementById('f-temp').textContent = data.facts.temp_max;
                } else {
                    document.getElementById('uplift-text').textContent = data.error || 'Could not load data.';
                }
            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Fetch error:', e);
                    document.getElementById('uplift-text').textContent = 'Connection issue. Please refresh.';
                }
            }
            
            loader.classList.add('hidden');
            content.classList.remove('hidden');
        }

        function openSettings() {
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('city-input').value = '';
            document.getElementById('city-results').innerHTML = '';
            document.getElementById('current-loc').innerHTML = `<small>Current: <strong>${state.city}</strong></small>`;
            document.getElementById('city-input').focus();
        }

        function closeSettings() {
            // Cancel any pending search
            if (searchController) {
                searchController.abort();
                searchController = null;
            }
            clearTimeout(searchTimer);
            document.getElementById('overlay').classList.add('hidden');
        }

        function handleOverlayClick(e) {
            if (e.target.id === 'overlay') closeSettings();
        }

        document.getElementById('city-input').addEventListener('input', function() {
            const query = this.value.trim();
            
            // Clear previous timer
            clearTimeout(searchTimer);
            
            // Cancel previous request
            if (searchController) {
                searchController.abort();
                searchController = null;
            }
            
            if (query.length < 2) {
                document.getElementById('city-results').innerHTML = '';
                return;
            }
            
            // Debounce
            searchTimer = setTimeout(() => searchCity(query), 300);
        });

        async function searchCity(q) {
            const list = document.getElementById('city-results');
            const requestId = ++searchRequestId;
            
            // Create new controller for this request
            searchController = new AbortController();
            
            list.innerHTML = '<li class="searching">Searching...</li>';
            
            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`, {
                    signal: searchController.signal
                });
                
                // Check if this is still the active request
                if (requestId !== searchRequestId) return;
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                // Double-check request is still active
                if (requestId !== searchRequestId) return;
                
                if (data.length === 0) {
                    list.innerHTML = '<li class="no-results">No cities found</li>';
                    return;
                }
                
                list.innerHTML = '';
                data.forEach(city => {
                    const li = document.createElement('li');
                    const parts = [city.name];
                    if (city.admin1) parts.push(city.admin1);
                    if (city.country) parts.push(city.country);
                    li.textContent = parts.join(', ');
                    li.addEventListener('click', () => selectCity(city.name, city.latitude, city.longitude, city.country));
                    list.appendChild(li);
                });
            } catch (e) {
                if (e.name !== 'AbortError' && requestId === searchRequestId) {
                    console.error('Search error:', e);
                    list.innerHTML = '<li class="error">Search failed. Try again.</li>';
                }
            }
        }

        function selectCity(name, lat, lon, country) {
            const fullName = country ? `${name}, ${country}` : name;
            
            state.city = fullName;
            state.lat = lat;
            state.lon = lon;
            
            localStorage.setItem('sh_city', fullName);
            localStorage.setItem('sh_lat', String(lat));
            localStorage.setItem('sh_lon', String(lon));
            
            document.getElementById('location-label').textContent = fullName;
            closeSettings();
            fetchData();
        }

        function toggleChangelog() {
            const changelog = document.getElementById('changelog');
            changelog.classList.toggle('hidden');
        }

        function applyHighlights(text, highlights) {
            if (!highlights || highlights.length === 0) {
                return escapeHtml(text);
            }
            
            let result = text;
            // Sort highlights by length (longest first) to avoid partial replacements
            const sortedHighlights = [...highlights].sort((a, b) => b.length - a.length);
            
            for (const phrase of sortedHighlights) {
                const escaped = escapeHtml(phrase);
                const regex = new RegExp(escapeRegex(phrase), 'gi');
                result = result.replace(regex, `<mark>${escaped}</mark>`);
            }
            
            return escapeHtml(result).replace(/&lt;mark&gt;/g, '<mark>').replace(/&lt;\/mark&gt;/g, '</mark>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
    </script>
</body>
</html>